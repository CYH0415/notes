# 为什么选择TCP/IP

网络通信协议 -> 网络通信中数据的格式约定。
协议分层：为了实现网络互连，一些组织根据不同服务提供的不同协议接口将复杂的网络通信环境划分为多个层次。

经典的OSI七层模型（应用层，表示层，会话层，传输层，网络层，链路层，物理层）。每一层的具体功能没有详细介绍。

- OSI的优点在于服务、接口和协议的三个概念被清晰地分离。概念清晰，理论相对完整。通过七层的层次结构模型，不同的系统和不同的网络可以实现可靠的通信；
- 但是复杂且不实用。

# TCP/IP

**互联网协议套件**是在互联网和类似的计算机网络中使用的通信协议集。套件中当前的基础协议是传输控制协议（TCP）和因特网协议（IP）。

由于网络通信协议通常采用分层结构（如上述的OSI模型），当多层协议一起工作时，类似于计算机科学中的堆栈，因此也被称为tcp/ip协议栈。

## 那么OSI和TCP/IP之间的关联是什么呢？

一般来说，人们认为OSI模型的顶部三层（应用层、表示层和会话层）在tcp/ip组中是一个应用层。因此，我们可以认为TCP/IP是OSI的简化版本。以下是TCP/IP的主要四层（可能还有另一个物理层，但我们在这里不关心它）。其中，前三层对我们来说更重要。
![[Pasted image 20240411112936.png|350]]
现在让我们简单地了解一下这三层。

# 应用层

## 一个例子

例如：当前正在开发一个关于“外卖下单”的软件项目。其中一个功能是获取用户的订单历史记录（后端服务器从数据库接收数据并返回给前端页面）。

正如我们所知，前端和后端的交互是基于网络的。因此，在这种交互过程中，我们需要达成一致：前端发送什么样的数据，后端返回相应的数据：

> 发送的请求需要包含：用户的ID、查询的起始时间、查询的结束时间、显示的条目数。
> 返回的响应包括：查询是否成功、如果失败，失败的原因、结果数组。
> 数组的每个元素包含以下属性：
> - 商品名称
> - 商品单价
> - 商品数量
> - 店铺名称
> - 总金额

以上工作是设计一个应用层协议。

总结：当应用程序之间需要网络通信时，在TCP/IP五层协议的应用层中，程序员需要定制应用层协议。

# 常见的应用层协议

- DNS：域名解析
- FTP：文件传输协议
- Telnet：远程终端协议
- HTTP：超文本传输协议，是网络上可靠数据交换的重要基础
  - HTTP是**无状态**的，也就是说：
    - 每个HTTP请求是独立的；服务器无法从消息中推断出您是谁，除非您提供证明（例如，提供一个Cookie）。
    - 相反，服务器维护状态：例如Cookies和Sessions。

# 传输层

传输层中最著名的两个协议是UDP和TCP，发送方发送的数据和接收方接收的数据是传输层的主要关注点。

## UDP（用户数据报协议）

UDP是一种非连接的传输协议，提供不可靠的非连接传输服务，是面向消息的。
- 没有连接。
- 不可靠。
- 更快速。

UDP消息没有可靠性保证、序列保证和流量控制字段，因此其可靠性较差。然而，由于UDP协议具有较少的控制选项，在数据传输过程中具有较小的延迟和高数据传输效率，适用于不要求高可靠性的应用。

# TCP（传输控制协议）

TCP是非常重要的传输层协议，在实际开发中被广泛使用。为了确保安全性和效率，TCP的实现有些复杂但并不难，这里不进行介绍。
1. TCP是面向连接的和可靠的，而UDP是非连接的和不可靠的。
2. TCP可用于可靠传输大量数据，而UDP可用于高效传输，例如实时广播。
3. TCP连接只能是点对点的，而UDP支持一对多、多对多、一对多。
4. 为了确保传输的可靠性，TCP在IP协议的基础上添加了序列号机制、确认机制等，不会丢失数据包，而UDP会丢失数据包。因此，TCP的成本高于UDP。
5. TCP在两个进程之间建立了一个**字节流**。因此，在上面的协议（如HTTP）中需要区分两个相邻消息。

- HTTP：使用CRLF（\\r\\n\\r\\n）
处理不当可能导致安全问题：
CRLF注入：https://owasp.org/www-community/vulnerabilities/CRLF_Injection
HTTP请求走私：https://blog.csdn.net/gg_53142368/article/details/124596233

# 网络层

此层有两个任务：
- IP地址控制
- 路由

## IP地址控制

IP地址是点分十进制数据，将IP地址分成两部分：网络号 + 主机号。
- 网络号：描述当前网络段的信息
- 主机号：区分局域网内的主机

通常要求：在同一局域网中，主机之间的网络号相同，主机号不能相同；两个相邻局域网的网络号（由同一个路由器连接）不能相同。
为了控制所有IP地址，例如IPv4，需要分配32位空间。我们需要一些标准和原则：动态分配、NAT等。无论如何，每个主机和网络必须有自己的IP地址才能上网。

# 路由

路由是找到路径的方案。两个设备之间需要找到一条路径来完成传输过程。路由器在此过程中起着重要作用。路由算法在此不做介绍。
路由器检查是否知道您的目标IP地址：
- 如果知道，则告诉目标的最佳路径；
- 如果不知道，则告诉您可能知道目标的路由器。

# 链路层

数据链路层考虑相邻节点之间的数据传输。这部分不是很重要。

# 如何调试异常连接？

在工作中，网络是我们关心的问题。有一些工具可以帮助解决网络异常连接的问题。

## 一些工具

### ipconfig（检查IP地址）适用于Windows / Linux中的ipconfig

在cmd中输入ipconfig。

如果要查看DNS或MAC地址，输入“ipconfig /all”。

### ping（测试到特定地址的连接）

命令：ping + IP或DNS地址

如上所述，'ping'可以测试连接的速度和稳定性。我们可以输入'ping ... -t'来在一段时间内对某个地方进行ping测试。

### nslookup（测试DNS配置）

命令：nslookup

如果有类似上面的回答，则您的本地DNS地址是正确的。
您还可以检查特定的DNS，输入“server +DNS地址”。

如果发现使用'ping'连接地址无效，则可以使用'tracert'进行跟踪（可能需要一些时间）。我们可以添加'-d'参数来加快速度。

### telnet（测试服务器的某个端口）

命令：telnet + IP地址/DNS + 端口号

每个服务器的服务都有其端口，因此我们可以使用'telnet'进行检查。例如，Web服务的端口号是80，FTP是21，DNS是53。在cmd中输入：“telnet www.baidu.com 80”。

如果弹出窗口如上所示，则端口可以有效访问。

### curl（获取站点内容）

命令：curl + 站点

- 无参数：向站点发送“GET”请求。
- '-d'参数：向站点发送“POST”请求。更多用法：http://www.ruanyifeng.com/blog/2019/09/curl-reference.html

### wget

- 检查IP地址和端口的连接。
- 类似于'curl'

### netstat（显示连接、路由、接口）

命令：netstat \[-a] \[-e] \[-n] \[-o] \[-p Protocol] \[-r] \[-s] \[Interval]

常用于检查本地Internet连接的情况。

## 总结

这里只是对一些互联网工具进行了简要介绍，您可以通过学习更多来了解它们。在处理异常连接时，我们经常一起使用这些工具。

- 例如，您可以使用'ping'检查到服务器的某些连接，然后使用'telnet'直接端口，或者使用'tracert'跟踪互联网，最后使用'curl'发送“POST”请求。
除了这里没有提到的其他工具，如果您熟练使用上述工具，许多问题都可以解决。

# Tcpdump

## 什么是'tcpdump'

- 用于Linux的网络工具。（适用于系统管理员）
- **Tcpdump**是一种数据网络数据包分析器计算机程序，运行在命令行界面下。它允许用户显示在计算机所连接的网络上传输或接收的TCP/IP和其他数据包。
- 作为互联网上的经典必备工具，tcpdump因其强大的功能和灵活的拦截策略已成为每个高级系统管理员分析网络和解决问题的必备工具之一。
- 以上只是简单的介绍。

## 如何使用

命令：tcpdump \[-aAbdDefhHI]KILnNOpqStuUvxX#] \[ -B size ] \[ -c count ][ -C file_size ][ -E algo:secret ][ -F file ] [ -G seconds

number
[-i interface ][ -j tstamptype ][ -M secret ][ -
[ -Q in|out|inout ]
precision ]
file ]
postrotate-command]
[-r file ][ -s snapple ][ --time-stamp-precision
[ --immediate-mode ][ -T type ][ --version ][ -V
[ -w file ][ -W filecount ] [ -y datalinktype ][ -z
[-Z user ][ expression ]

输出形式：系统时间 + 源主机端口 > 目的主机端口 + 数据包参数。
如果没有参数，'tcpdump'将搜索系统中第一个网络接口并显示其捕获的所有数据。显然，我们不希望获得这样的无用消息，因此使用tcpdump的关键是为我们选择有效的消息。

# 表达式

Tcpdump使用正则表达式作为过滤数据包的条件。如果数据包满足表达式的条件，它们将被捕获。如果未给出条件，则将截取网络上的所有数据包。表达式中常见的关键字如下：

-

 指定参数类型的关键字主要包括'host'、'net'、'port'等。如果未指定类型，则默认为host；
- 指定数据消息传输方向的关键字，主要包括'src'、'dst'等。
- 指定协议的关键字，主要包括'FDDI'、'IP'、'ARP'、'RARP'、'TCP'、'UDP'等类型，默认情况下会监听所有协议的数据包；
- 其他重要关键字：'gateway'、'broadcast'、'ess'、'greater'以及三种逻辑操作。

表达式的使用非常灵活有效，可以帮助我们显著简化问题。

# 参数

这里列出了一些'tcpdump'的有用参数：

- -a以ASCII格式打印所有数据包，并最小化链路层头部。
- -b选择数据链路层上的协议，包括IP、ARP、RARP和IPX。
- -c接收指定数量的数据包后，tcpdump将停止。
- -D打印出系统中所有可以使用tcpdump拦截数据包的网络接口。
- -I指定要监听的网络接口。
- -L将标准输出更改为带缓冲的行形式，可以将数据导出到文件。
- -N不将网络地址转换为名称。
- -0不运行数据包匹配代码优化器。
- -g快速输出。只输出少量协议信息。
- -W将组直接写入文件，而不进行分析和打印。

以上内容为使用'tcpdump'的关键。